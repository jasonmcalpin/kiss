# Feature: Turn Management

## User Story
As a player, I want to take turns managing my nation's actions including resource management, diplomacy, and combat so that I can strategically develop my empire and compete with other players.

## Acceptance Criteria
- [ ] Player can see when it's their turn to act
- [ ] Player can perform multiple actions during their turn
- [ ] Player can end their turn when finished with actions
- [ ] Turn order is maintained and enforced
- [ ] Turn timer limits how long players can take
- [ ] Players are notified when their turn begins
- [ ] Game processes all actions at end of turn phase
- [ ] Players can see turn history and what others did

## BDD Scenarios

### Scenario 1: Player Receives Turn Notification
**Given** it is currently "Admiral Smith's" turn  
**And** Admiral Smith has completed their turn  
**When** the turn advances to me  
**Then** I should receive a notification "It's your turn!"  
**And** I should see "Your Turn" highlighted in the game interface  
**And** I should see the turn timer start counting down  
**And** other players should see "Waiting for [My Name]"  

### Scenario 2: Player Performs Multiple Actions During Turn
**Given** it is my turn  
**And** I have 5 minutes remaining on the turn timer  
**When** I build a ship on Terra Prime  
**And** I move my fleet to the Centauri system  
**And** I send a diplomatic proposal to Captain Jones  
**And** I research "Advanced Weapons Technology"  
**Then** all actions should be queued for processing  
**And** I should see a summary of my planned actions  
**And** I should still be able to perform additional actions  

### Scenario 3: Player Ends Turn Early
**Given** it is my turn  
**And** I have completed all the actions I want to take  
**And** there are 3 minutes remaining on the turn timer  
**When** I click "End Turn"  
**And** I confirm "Yes, end my turn"  
**Then** my turn should end immediately  
**And** the turn should advance to the next player  
**And** my actions should be processed  

### Scenario 4: Turn Timer Expires
**Given** it is my turn  
**And** the turn timer shows 10 seconds remaining  
**When** the timer reaches 0  
**Then** my turn should automatically end  
**And** I should see "Turn time expired" message  
**And** any actions I had queued should still be processed  
**And** the turn should advance to the next player  

### Scenario 5: Player Views Turn Order
**Given** I am in an active game with 4 players  
**When** I click on "Turn Order" or view the game status  
**Then** I should see the current turn order  
**And** I should see "1. Admiral Smith (current)"  
**And** I should see "2. Captain Jones (next)"  
**And** I should see "3. [My Name] (waiting)"  
**And** I should see "4. Emperor Zara (waiting)"  

### Scenario 6: Player Reviews Turn History
**Given** several turns have been completed  
**When** I click on "Turn History" or "Game Log"  
**Then** I should see a chronological list of turns  
**And** I should see "Turn 5: Admiral Smith built 2 cruisers, moved fleet to Alpha Centauri"  
**And** I should see "Turn 5: Captain Jones researched Shield Technology"  
**And** I should see what actions each player took each turn  

### Scenario 7: Simultaneous Turn Processing
**Given** all players have ended their turns  
**When** the turn processing phase begins  
**Then** I should see "Processing turn..." message  
**And** all player actions should be resolved simultaneously  
**And** combat should be calculated and resolved  
**And** resource production should be updated  
**And** construction should advance  
**And** the next turn should begin  

### Scenario 8: Player Cannot Act When Not Their Turn
**Given** it is currently "Captain Jones'" turn  
**And** I am waiting for my turn  
**When** I try to build a ship  
**Then** I should see "Wait for your turn" message  
**And** the action should be blocked  
**And** I should only be able to view information and plan  

### Scenario 9: Player Rejoins Game During Their Turn
**Given** I was disconnected from the game  
**And** it is currently my turn  
**When** I reconnect to the game  
**Then** I should see "It's your turn!" notification  
**And** I should see how much time remains on the turn timer  
**And** I should be able to continue taking actions  
**And** any actions I had queued before disconnecting should still be there  

### Scenario 10: Turn Skipped Due to Elimination
**Given** "Emperor Zara" has been eliminated from the game  
**And** it would normally be Emperor Zara's turn  
**When** the turn order reaches Emperor Zara  
**Then** their turn should be automatically skipped  
**And** the turn should advance to the next active player  
**And** all players should be notified of the skip  

## Implementation Notes

### Database Requirements
- game_turns table: game_id, turn_number, current_player_id, turn_start_time, turn_end_time, status
- turn_actions table: game_id, turn_number, player_id, action_type, action_data, processed
- turn_order table: game_id, player_id, order_position, is_active
- turn_history table: game_id, turn_number, player_id, action_summary, timestamp

### API Endpoints
- GET /api/games/{id}/turn - Get current turn information
- POST /api/games/{id}/turn/end - End current player's turn
- GET /api/games/{id}/turn/actions - Get queued actions for current turn
- POST /api/games/{id}/turn/actions - Queue action for current turn
- GET /api/games/{id}/turn/history - Get turn history
- GET /api/games/{id}/turn/order - Get turn order

### Frontend Components
- Turn status indicator showing whose turn it is
- Turn timer with countdown display
- "End Turn" button (only visible during player's turn)
- Turn history/game log viewer
- Turn order display
- Action queue summary
- Turn processing status indicator

### Turn Timer Settings
- Default turn time: 5 minutes
- Warning at 1 minute remaining
- Final warning at 30 seconds
- Configurable per game (1-10 minutes)
- Pause timer for disconnected players (optional)

### Turn Processing Order
1. Collect all player actions
2. Resolve diplomatic actions
3. Process movement orders
4. Resolve combat
5. Update resource production
6. Process construction
7. Apply research progress
8. Check victory conditions
9. Start next turn

## Status
- [ ] Database schema for turn management
- [ ] Turn order and timing system
- [ ] Turn timer implementation
- [ ] Action queuing system
- [ ] Turn processing engine
- [ ] Turn history tracking
- [ ] Real-time turn notifications
- [ ] Frontend turn management interface
- [ ] Reconnection handling during turns
- [ ] Tests written
- [ ] Feature complete
