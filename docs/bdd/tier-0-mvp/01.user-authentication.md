# Feature: User Authentication

## User Stories
1. **As a new user**, I want to register an account with a display name so that other players can recognize me in games
2. **As a returning user**, I want to log in so that I can access my saved games
3. **As a logged-in user**, I want to log out so that I can secure my account
4. **As a user**, I want to see my game history so that I can track my progress
5. **As a user**, I want a unique handle for chat so that my identity is consistent across games

## Acceptance Criteria
- [ ] User can register with username, email, display name, and chat handle
- [ ] User can log in with username/password
- [ ] User can log out securely
- [ ] User can view their game history
- [ ] Display names and chat handles are shown appropriately in UI
- [ ] Proper error handling for invalid credentials and duplicate usernames
- [ ] Password security (hashing, validation)

## BDD Scenarios

### Scenario 1: Successful User Registration with Display Name
**Given** I am on the registration page  
**When** I enter username "player123"  
**And** I enter email "player@example.com"  
**And** I enter display name "Admiral Smith"  
**And** I enter chat handle "AdmiralS"  
**And** I enter password "SecurePass123!"  
**And** I confirm password "SecurePass123!"  
**And** I click "Register"  
**Then** my account should be created  
**And** I should be logged in automatically  
**And** I should see the game dashboard  
**And** my profile should show display name "Admiral Smith"  
**And** my chat handle should be "AdmiralS"  

### Scenario 2: Successful Login
**Given** I have an existing account with username "player123"  
**And** I am on the login page  
**When** I enter username "player123"  
**And** I enter password "SecurePass123!"  
**And** I click "Login"  
**Then** I should be logged in  
**And** I should see the game dashboard  

### Scenario 3: Invalid Login Credentials
**Given** I am on the login page  
**When** I enter username "player123"  
**And** I enter password "wrongpassword"  
**And** I click "Login"  
**Then** I should see an error message "Invalid credentials"  
**And** I should remain on the login page  

### Scenario 4: Duplicate Username Registration
**Given** a user with username "player123" already exists  
**When** I try to register with username "player123"  
**Then** I should see an error message "Username already taken"  
**And** the account should not be created  

### Scenario 5: Duplicate Email Registration
**Given** a user with email "player@example.com" already exists  
**When** I try to register with email "player@example.com"  
**Then** I should see an error message "Email already registered"  
**And** the account should not be created  

### Scenario 6: Successful Logout
**Given** I am logged in  
**When** I click "Logout"  
**Then** I should be logged out  
**And** I should be redirected to the login page  
**And** my session should be invalidated  

### Scenario 7: View Game History
**Given** I am logged in  
**And** I have participated in 3 games  
**When** I navigate to "My Games"  
**Then** I should see a list of my 3 games  
**And** each game should show my status (won/lost/active)  
**And** each game should show the game name and date  

### Scenario 8: Empty Game History
**Given** I am logged in  
**And** I have not participated in any games  
**When** I navigate to "My Games"  
**Then** I should see a message "No games played yet"  
**And** I should see a button to "Join a Game"  

## Database Schema Requirements

### users table
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    chat_handle VARCHAR(50) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### user_games table (for game history)
```sql
CREATE TABLE user_games (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    game_id INT NOT NULL,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('active', 'won', 'lost', 'eliminated', 'abandoned') DEFAULT 'active',
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (game_id) REFERENCES games(id),
    UNIQUE KEY unique_user_game (user_id, game_id)
);
```

## API Endpoints

### Authentication Endpoints
- **POST /api/auth/register**
  - Body: `{ username, email, display_name, chat_handle, password, password_confirm }`
  - Response: `{ user: {...}, token: "..." }`

- **POST /api/auth/login**
  - Body: `{ username, password }`
  - Response: `{ user: {...}, token: "..." }`

- **POST /api/auth/logout**
  - Headers: `Authorization: Bearer <token>`
  - Response: `{ message: "Logged out successfully" }`

### User Data Endpoints
- **GET /api/user/profile**
  - Headers: `Authorization: Bearer <token>`
  - Response: `{ id, username, email, display_name, chat_handle, created_at }`

- **GET /api/user/games**
  - Headers: `Authorization: Bearer <token>`
  - Response: `{ games: [{ id, name, status, joined_at, ... }] }`

## Security Requirements
- [ ] Password hashing using bcrypt or similar
- [ ] JWT token-based authentication
- [ ] Session management and token expiration
- [ ] CSRF protection
- [ ] Input validation and sanitization
- [ ] Rate limiting on login attempts
- [ ] Secure password requirements (length, complexity)

## Frontend Components
- [ ] Registration form component
- [ ] Login form component
- [ ] Logout functionality
- [ ] User profile display
- [ ] Game history list component
- [ ] Error message handling
- [ ] Form validation

## Implementation Status
- [ ] Database schema created
- [ ] User registration API endpoint
- [ ] User login API endpoint
- [ ] User logout API endpoint
- [ ] User profile API endpoint
- [ ] Game history API endpoint
- [ ] Frontend registration form
- [ ] Frontend login form
- [ ] Frontend game history view
- [ ] Password hashing implementation
- [ ] JWT token management
- [ ] Input validation
- [ ] Error handling
- [ ] Unit tests written
- [ ] Integration tests written
- [ ] Feature complete

## Related Features
- **password-recovery.md** - Password reset functionality
- **user-profile.md** - Edit profile information
- **game-history.md** - Detailed game statistics and history

## Notes
- Current turn tracking belongs in the `games` table, not user table
- Chat handle can default to display_name if not provided
- Consider email verification for production
- Password recovery will be a separate feature due to complexity
